@* Sección de Citas *@
<section id="appointment" class="appointment section light-background">
  <div class="container section-title" data-aos="fade-up">
    <h2>Agenda tu Cita</h2>
    <p>Completa el siguiente formulario y uno de nuestros profesionales se pondrá en contacto contigo lo antes posible.</p>
    <p>En Clínica Los Angeles, tu bienestar es nuestra prioridad.</p>
  </div>
  <div class="container" data-aos="fade-up" data-aos-delay="100">
    @if (User.Identity != null && User.Identity.IsAuthenticated && User.IsInRole("Paciente"))
    {
        if (TempData["CitaAgendada"] != null)
        {
            <div class="alert text-center" style="background:#3fbbc0;color:#fff;">@TempData["CitaAgendada"]</div>
        }
    <form action="/Citas/AgendarDesdeHome" method="post" role="form">
            @Html.AntiForgeryToken()
            <div class="row">
                <div class="col-md-3 form-group">
                    <label for="name" class="form-label">Nombre</label>
                    <input type="text" name="name" class="form-control" id="name" placeholder="Nombre" required>
                </div>
                <div class="col-md-3 form-group mt-3 mt-md-0">
                    <label for="apellido" class="form-label">Apellido</label>
                    <input type="text" name="apellido" class="form-control" id="apellido" placeholder="Apellido" required>
                </div>
                <div class="col-md-2 form-group mt-3 mt-md-0">
                    <label for="ci" class="form-label">CI (opcional)</label>
                    <input type="text" name="ci" class="form-control" id="ci" placeholder="CI (opcional)" maxlength="20">
                </div>
                <div class="col-md-2 form-group mt-3 mt-md-0">
                    <label for="fechaNacimiento" class="form-label">Fecha de nacimiento</label>
                    <input type="date" name="fechaNacimiento" class="form-control" id="fechaNacimiento" placeholder="Fecha de nacimiento">
                </div>
                <div class="col-md-2 form-group mt-3 mt-md-0">
                    <label for="phone" class="form-label">Teléfono</label>
                    <input type="tel" class="form-control" name="phone" id="phone" placeholder="Teléfono" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 form-group mt-3">
                    <input type="datetime-local" name="date" class="form-control datepicker" id="date" placeholder="Fecha de la Cita" required min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")">
                </div>
                <div class="col-md-4 form-group mt-3">
                    <select name="department" id="department" class="form-select" required>
                        <option value="">Seleccionar Especialidad</option>
                        @foreach (var esp in (IEnumerable<ClinicaCitas.Models.Especialidad>)ViewBag.Especialidades)
                        {
                            <option value="@esp.EspecialidadId">@esp.Nombre</option>
                        }
                    </select>
                </div>
                <div class="col-md-4 form-group mt-3">
                    <select name="doctor" id="doctor" class="form-select" required>
                        <option value="">Seleccionar Médico</option>
                        @foreach (var med in (IEnumerable<ClinicaCitas.Models.Medico>)ViewBag.Medicos)
                        {
                            <option value="@med.MedicoId" data-especialidad="@med.EspecialidadId">@med.Nombre @med.Apellido</option>
                        }
                    </select>
                </div>
            </div>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    var deptSelect = document.getElementById('department');
                    var docSelect = document.getElementById('doctor');
                    deptSelect.addEventListener('change', function () {
                        var espId = this.value;
                        Array.from(docSelect.options).forEach(function (opt) {
                            if (!opt.value) return;
                            opt.style.display = (opt.getAttribute('data-especialidad') === espId) ? '' : 'none';
                        });
                        docSelect.value = '';
                    });
                });
            </script>
            <div class="form-group mt-3">
                <textarea class="form-control" name="message" rows="5" placeholder="Mensaje (Opcional)"></textarea>
            </div>
            <div class="mt-3">
                <div class="mt-3">
                    <div class="loading" style="display:none; color:#3fbbc0; font-weight:bold;">Enviando solicitud...</div>
                    <div class="error-message" style="display:none; color:#df1529; font-weight:bold;">Ocurrió un error. Intenta de nuevo.</div>
                    <div class="sent-message" style="display:none; color:#3fbbc0; font-weight:bold;">¡Tu cita fue enviada correctamente! Gracias.</div>
                    <div class="text-center">
                        <button type="button" onclick="enviarCita(this);return false;" class="btn-get-started" style="background:#3fbbc0;color:#fff;border:none;box-shadow:0 2px 8px rgba(63,187,192,0.15);padding:8px 32px;font-size:14px;letter-spacing:1px;border-radius:5px;">Agendar Cita</button>
                    </div>
                </div>
                <script>
                function enviarCita(btn) {
                    var form = btn.closest('form');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    var loading = form.querySelector('.loading');
                    var error = form.querySelector('.error-message');
                    var sent = form.querySelector('.sent-message');
                    loading.style.display = 'block';
                    error.style.display = 'none';
                    sent.style.display = 'none';
                    btn.style.pointerEvents = 'none';
                    btn.style.opacity = '0.7';
                    fetch(form.action, {
                        method: 'POST',
                        body: new FormData(form),
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(r => {
                        loading.style.display = 'none';
                        btn.style.pointerEvents = '';
                        btn.style.opacity = '';
                        if (r.ok) {
                            sent.style.display = 'block';
                            form.reset();
                        } else {
                            error.style.display = 'block';
                        }
                    })
                    .catch(() => {
                        loading.style.display = 'none';
                        error.style.display = 'block';
                        btn.style.pointerEvents = '';
                        btn.style.opacity = '';
                    });
                }
                </script>
            </div>
        </form>
    }
    else
    {
        <div class="alert alert-info text-center">Debes iniciar sesión como paciente para agendar una cita.</div>
        <div class="text-center mt-3">
            <a href="/Usuarios/Login" class="btn" style="background:#3fbbc0;color:#fff;border:none;box-shadow:0 2px 8px rgba(63,187,192,0.15);padding:8px 32px;font-size:14px;letter-spacing:1px;border-radius:5px;">Iniciar Sesión</a>
        </div>
    }
  </div>
</section>
